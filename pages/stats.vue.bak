<!--
  Statistics Page - FlowSip çµ±è¨ˆé é¢
  
  æ•´åˆçµ±è¨ˆåŠŸèƒ½çš„å®Œæ•´é é¢
  åŒ…å«çµ±è¨ˆå¡ç‰‡ã€åœ–è¡¨ã€æ™‚é–“ç¯„åœé¸æ“‡ã€å ±è¡¨åŠŸèƒ½ç­‰
  éµå¾ªéŸ¿æ‡‰å¼è¨­è¨ˆå’Œæ­£é«”ä¸­æ–‡è¦ç¯„
-->

<template>
  <div class="stats-page">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="page-header">
      <div class="header-content">
        <h1 class="page-title">ğŸ“Š çµ±è¨ˆåˆ†æ</h1>
        <p class="page-subtitle">è¿½è¹¤æ‚¨çš„å°ˆæ³¨æ™‚é–“å’Œç¿’æ…£é¤Šæˆé€²åº¦</p>
      </div>
      
      <!-- æ“ä½œæŒ‰éˆ• -->
      <div class="header-actions">
        <div class="time-range-selector">
          <select
            v-model="selectedTimeRange"
            class="range-select"
            @change="handleTimeRangeChange"
          >
            <option value="today">ä»Šæ—¥</option>
            <option value="week">æœ¬é€±</option>
            <option value="month">æœ¬æœˆ</option>
            <option value="all">å…¨éƒ¨</option>
          </select>
        </div>
        
        <div class="action-buttons">
          <button 
            class="refresh-btn"
            :disabled="isLoading"
            @click="handleRefresh"
          >
            <span class="btn-icon">ğŸ”„</span>
            <span class="btn-text">åˆ·æ–°</span>
          </button>
          
          <div ref="exportDropdown" class="export-dropdown">
            <button
              class="export-btn"
              @click="toggleExportMenu"
            >
              <span class="btn-icon">ğŸ“Š</span>
              <span class="btn-text">åŒ¯å‡º</span>
              <span class="dropdown-arrow">â–¼</span>
            </button>
            
            <div v-show="showExportMenu" class="export-menu">
              <button class="export-option" @click="handleExport('json')">
                JSON æ ¼å¼
              </button>
              <button class="export-option" @click="handleExport('csv')">
                CSV æ ¼å¼
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è¼‰å…¥ç‹€æ…‹ -->
    <div v-if="isLoading" class="loading-container">
      <div class="loading-spinner"/>
      <p class="loading-text">è¼‰å…¥çµ±è¨ˆè³‡æ–™ä¸­...</p>
    </div>

    <!-- éŒ¯èª¤ç‹€æ…‹ -->
    <div v-else-if="error" class="error-container">
      <div class="error-content">
        <div class="error-icon">âš ï¸</div>
        <h3 class="error-title">è¼‰å…¥å¤±æ•—</h3>
        <p class="error-message">{{ error.message }}</p>
        <button class="retry-button" @click="handleRefresh">
          é‡æ–°è¼‰å…¥
        </button>
      </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ */
    <div v-else class="stats-content">
      <!-- æ‘˜è¦å¡ç‰‡å€åŸŸ -->
      <section class="summary-section">
        <h2 class="section-title">çµ±è¨ˆæ‘˜è¦</h2>
        
        <div class="stats-cards-grid">
          <!-- ç¸½æ´»å‹•æ•¸å¡ç‰‡ -->
          <StatsCard
            v-if="summary"
            title="ç¸½æ´»å‹•æ•¸"
            subtitle="å·²å®Œæˆçš„è¨ˆæ™‚æ´»å‹•"
            :value="totalActivities"
            unit="æ¬¡"
            icon="ğŸ¯"
            type="primary"
            :trend="activitiesTrend"
            :show-trend="true"
            :secondary-info="[
              { label: 'å–æ°´', value: `${summary.water.completedSessions} æ¬¡` },
              { label: 'ç•ªèŒ„é˜', value: `${summary.pomodoro.completedSessions} æ¬¡` }
            ]"
            :chart-data="recentActivitiesData"
            :show-mini-chart="true"
            :last-updated="summary.lastUpdated"
            :show-footer="true"
          />
          
          <!-- å°ˆæ³¨æ™‚æ•¸å¡ç‰‡ -->
          <StatsCard
            v-if="summary"
            title="å°ˆæ³¨æ™‚æ•¸"
            subtitle="ç´¯è¨ˆå°ˆæ³¨æ™‚é–“"
            :value="totalHours"
            unit="å°æ™‚"
            icon="â°"
            type="success"
            :trend="hoursTrend"
            :show-trend="true"
            :secondary-info="[
              { label: 'æ—¥å¹³å‡', value: `${averageHoursPerDay} å°æ™‚` },
              { label: 'æœ€é•·é€£çºŒ', value: `${Math.max(summary.water.streak, summary.pomodoro.streak)} å¤©` }
            ]"
            :chart-data="recentHoursData"
            :show-mini-chart="true"
            :last-updated="summary.lastUpdated"
            :show-footer="true"
          />
          
          <!-- å®Œæˆç‡å¡ç‰‡ -->
          <StatsCard
            v-if="summary"
            title="å®Œæˆç‡"
            subtitle="ä»»å‹™å®Œæˆç™¾åˆ†æ¯”"
            :value="completionRatePercent"
            unit="%"
            icon="âœ…"
            type="info"
            :trend="completionTrend"
            :show-trend="true"
            :secondary-info="[
              { label: 'æœ€ä½³æ—¥æœŸ', value: summary.total.bestDay || 'æš«ç„¡' },
              { label: 'æœ€æ´»èºæ—¥', value: summary.total.mostActiveDay }
            ]"
            :last-updated="summary.lastUpdated"
            :show-footer="true"
          />
          
          <!-- é€£çºŒå¤©æ•¸å¡ç‰‡ -->
          <StatsCard
            v-if="summary"
            title="æœ€é•·é€£çºŒ"
            subtitle="é€£çºŒä½¿ç”¨å¤©æ•¸"
            :value="maxStreak"
            unit="å¤©"
            icon="ğŸ”¥"
            type="warning"
            :secondary-info="[
              { label: 'å–æ°´é€£çºŒ', value: `${summary.water.streak} å¤©` },
              { label: 'ç•ªèŒ„é˜é€£çºŒ', value: `${summary.pomodoro.streak} å¤©` }
            ]"
            :last-updated="summary.lastUpdated"
            :show-footer="true"
          />
        </div>
      </section>

      <!-- åœ–è¡¨å€åŸŸ -->
      <section class="charts-section">
        <h2 class="section-title">è©³ç´°çµ±è¨ˆ</h2>
        
        <div class="charts-container">
          <StatsCharts
            :height="400"
            :show-legend="true"
            :responsive="true"
          />
        </div>
      </section>

      <!-- è©³ç´°è³‡æ–™å€åŸŸ -->
      <section class="details-section">
        <h2 class="section-title">çµ±è¨ˆè©³æƒ…</h2>
        
        <div class="details-content">
          <!-- ä»Šæ—¥è©³æƒ… -->
          <div class="detail-card">
            <h3 class="detail-card-title">ä»Šæ—¥çµ±è¨ˆ</h3>
            <div v-if="todayStats" class="detail-card-content">
              <div class="detail-row">
                <span class="detail-label">å–æ°´æé†’</span>
                <span class="detail-value">{{ todayStats.waterCompletedCount }} æ¬¡</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">ç•ªèŒ„é˜</span>
                <span class="detail-value">{{ todayStats.pomodoroCompletedCount }} æ¬¡</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">ç¸½è¨ˆæ™‚é–“</span>
                <span class="detail-value">{{ formatDuration(todayStats.totalActiveTime) }}</span>
              </div>
            </div>
            <div v-else class="no-data-message">
              ä»Šæ—¥å°šç„¡çµ±è¨ˆè³‡æ–™
            </div>
          </div>
          
          <!-- æœ¬é€±è©³æƒ… -->
          <div class="detail-card">
            <h3 class="detail-card-title">æœ¬é€±çµ±è¨ˆ</h3>
            <div v-if="weekStats" class="detail-card-content">
              <div class="detail-row">
                <span class="detail-label">æ´»å‹•å¤©æ•¸</span>
                <span class="detail-value">{{ activeDaysThisWeek }} / 7 å¤©</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">é€±ç¸½æ™‚é–“</span>
                <span class="detail-value">{{ formatDuration(weekStats.weeklyTotals.totalActiveTime) }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">æ—¥å‡æ´»å‹•</span>
                <span class="detail-value">{{ weeklyAverageActivities.toFixed(1) }} æ¬¡</span>
              </div>
            </div>
            <div v-else class="no-data-message">
              æœ¬é€±å°šç„¡çµ±è¨ˆè³‡æ–™
            </div>
          </div>
          
          <!-- ç¿’æ…£åˆ†æ -->
          <div class="detail-card">
            <h3 class="detail-card-title">ç¿’æ…£åˆ†æ</h3>
            <div v-if="summary" class="detail-card-content">
              <div class="detail-row">
                <span class="detail-label">åå¥½æ´»å‹•</span>
                <span class="detail-value">{{ preferredActivity }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">å¹³å‡æœƒè©±</span>
                <span class="detail-value">{{ formatDuration(summary.total.averageSessionLength) }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">æ´»èºæ™‚æ®µ</span>
                <span class="detail-value">{{ summary.total.mostActiveDay }}</span>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted } from 'vue'
import { useStats } from '~/composables/useStats'
import type { StatsTimeRange } from '~/composables/useStats'
import StatsCard from '~/components/Stats/StatsCard.vue'
import StatsCharts from '~/components/Stats/Charts.vue'

// ============================================================================
// SEO è¨­å®š
// ============================================================================

useSeoMeta({
  title: 'çµ±è¨ˆåˆ†æ - FlowSip',
  description: 'æŸ¥çœ‹æ‚¨çš„å°ˆæ³¨æ™‚é–“çµ±è¨ˆå’Œç¿’æ…£é¤Šæˆé€²åº¦',
  ogTitle: 'çµ±è¨ˆåˆ†æ - FlowSip',
  ogDescription: 'è¿½è¹¤æ‚¨çš„å–æ°´æé†’å’Œç•ªèŒ„é˜ä½¿ç”¨çµ±è¨ˆ'
})

// ============================================================================
// Composables
// ============================================================================

const {
  isLoading,
  error,
  timeRange,
  summary,
  trends,
  todayStats,
  weekStats,
  setTimeRange,
  recalculateStats,
  generateReport
} = useStats()

// ============================================================================
// éŸ¿æ‡‰å¼è³‡æ–™
// ============================================================================

/** é¸ä¸­çš„æ™‚é–“ç¯„åœ */
const selectedTimeRange = ref<StatsTimeRange>('today')

/** æ˜¯å¦é¡¯ç¤ºåŒ¯å‡ºé¸å–® */
const showExportMenu = ref(false)

/** åŒ¯å‡ºä¸‹æ‹‰é¸å–®å¼•ç”¨ */
const exportDropdown = ref<HTMLElement>()

// ============================================================================
// è¨ˆç®—å±¬æ€§
// ============================================================================

/** ç¸½æ´»å‹•æ•¸ */
const totalActivities = computed(() => {
  if (!summary.value) return 0
  return summary.value.water.completedSessions + summary.value.pomodoro.completedSessions
})

/** ç¸½å°ˆæ³¨æ™‚æ•¸ */
const totalHours = computed(() => {
  if (!summary.value) return 0
  return (summary.value.total.activeTime / (60 * 60 * 1000)).toFixed(1)
})

/** å®Œæˆç‡ç™¾åˆ†æ¯” */
const completionRatePercent = computed(() => {
  if (!summary.value) return 0
  return Math.round(summary.value.total.completionRate * 100)
})

/** æœ€é•·é€£çºŒå¤©æ•¸ */
const maxStreak = computed(() => {
  if (!summary.value) return 0
  return Math.max(summary.value.water.streak, summary.value.pomodoro.streak)
})

/** æ—¥å¹³å‡å°ˆæ³¨æ™‚æ•¸ */
const averageHoursPerDay = computed(() => {
  if (!summary.value || summary.value.totalDays === 0) return '0.0'
  const avgMs = summary.value.total.activeTime / summary.value.totalDays
  return (avgMs / (60 * 60 * 1000)).toFixed(1)
})

/** æ´»å‹•æ•¸è¶¨å‹¢ */
const activitiesTrend = computed(() => {
  // ç°¡åŒ–çš„è¶¨å‹¢è¨ˆç®—ï¼Œå¯¦éš›å¯æ ¹æ“šæ­·å²è³‡æ–™è¨ˆç®—
  if (trends.value.length < 2) return 0
  
  const recent = trends.value.slice(-7)
  const earlier = trends.value.slice(-14, -7)
  
  if (earlier.length === 0) return 0
  
  const recentAvg = recent.reduce((sum, t) => sum + t.waterCount + t.pomodoroCount, 0) / recent.length
  const earlierAvg = earlier.reduce((sum, t) => sum + t.waterCount + t.pomodoroCount, 0) / earlier.length
  
  if (earlierAvg === 0) return 0
  return ((recentAvg - earlierAvg) / earlierAvg) * 100
})

/** æ™‚æ•¸è¶¨å‹¢ */
const hoursTrend = computed(() => {
  if (trends.value.length < 2) return 0
  
  const recent = trends.value.slice(-7)
  const earlier = trends.value.slice(-14, -7)
  
  if (earlier.length === 0) return 0
  
  const recentAvg = recent.reduce((sum, t) => sum + t.totalHours, 0) / recent.length
  const earlierAvg = earlier.reduce((sum, t) => sum + t.totalHours, 0) / earlier.length
  
  if (earlierAvg === 0) return 0
  return ((recentAvg - earlierAvg) / earlierAvg) * 100
})

/** å®Œæˆç‡è¶¨å‹¢ */
const completionTrend = computed(() => {
  // ç°¡åŒ–å¯¦ä½œï¼Œå¯¦éš›å¯æ ¹æ“šæ­·å²å®Œæˆç‡è¨ˆç®—
  return 0
})

/** æœ€è¿‘æ´»å‹•æ•¸è³‡æ–™ï¼ˆç”¨æ–¼è¿·ä½ åœ–è¡¨ï¼‰ */
const recentActivitiesData = computed(() => {
  return trends.value.slice(-7).map(t => t.waterCount + t.pomodoroCount)
})

/** æœ€è¿‘æ™‚æ•¸è³‡æ–™ï¼ˆç”¨æ–¼è¿·ä½ åœ–è¡¨ï¼‰ */
const recentHoursData = computed(() => {
  return trends.value.slice(-7).map(t => t.totalHours)
})

/** æœ¬é€±æ´»å‹•å¤©æ•¸ */
const activeDaysThisWeek = computed(() => {
  if (!weekStats.value) return 0
  return weekStats.value.dailyStats.filter(day => 
    day.waterCompletedCount > 0 || day.pomodoroCompletedCount > 0
  ).length
})

/** æœ¬é€±å¹³å‡æ´»å‹•æ•¸ */
const weeklyAverageActivities = computed(() => {
  if (!weekStats.value) return 0
  const total = weekStats.value.weeklyTotals.waterCompletedCount + 
                weekStats.value.weeklyTotals.pomodoroCompletedCount
  return total / 7
})

/** åå¥½æ´»å‹•é¡å‹ */
const preferredActivity = computed(() => {
  if (!summary.value) return 'æš«ç„¡è³‡æ–™'
  
  const waterSessions = summary.value.water.completedSessions
  const pomodoroSessions = summary.value.pomodoro.completedSessions
  
  if (waterSessions === pomodoroSessions) return 'å‡è¡¡ä½¿ç”¨'
  return waterSessions > pomodoroSessions ? 'å–æ°´æé†’' : 'ç•ªèŒ„é˜'
})

// ============================================================================
// æ–¹æ³•
// ============================================================================

/** è™•ç†æ™‚é–“ç¯„åœè®Šæ›´ */
function handleTimeRangeChange() {
  setTimeRange(selectedTimeRange.value)
}

/** è™•ç†åˆ·æ–° */
async function handleRefresh() {
  await recalculateStats()
}

/** åˆ‡æ›åŒ¯å‡ºé¸å–® */
function toggleExportMenu() {
  showExportMenu.value = !showExportMenu.value
}

/** è™•ç†åŒ¯å‡º */
async function handleExport(format: 'json' | 'csv') {
  try {
    const reportData = await generateReport(format)
    
    const blob = new Blob([reportData], {
      type: format === 'json' ? 'application/json' : 'text/csv'
    })
    
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `flowsip-stats-${new Date().toISOString().split('T')[0]}.${format}`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
    
    showExportMenu.value = false
  } catch (err) {
    console.error('åŒ¯å‡ºå¤±æ•—:', err)
    alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦')
  }
}

/** æ ¼å¼åŒ–æŒçºŒæ™‚é–“ */
function formatDuration(ms: number): string {
  const hours = Math.floor(ms / (60 * 60 * 1000))
  const minutes = Math.floor((ms % (60 * 60 * 1000)) / (60 * 1000))
  
  if (hours > 0) {
    return `${hours} å°æ™‚ ${minutes} åˆ†é˜`
  }
  return `${minutes} åˆ†é˜`
}

/** è™•ç†é»æ“Šå¤–éƒ¨é—œé–‰é¸å–® */
function handleClickOutside(event: Event) {
  if (exportDropdown.value && !exportDropdown.value.contains(event.target as Node)) {
    showExportMenu.value = false
  }
}

// ============================================================================
// ç”Ÿå‘½é€±æœŸ
// ============================================================================

onMounted(() => {
  // åˆå§‹åŒ–æ™‚é–“ç¯„åœ
  selectedTimeRange.value = timeRange.value
  
  // æ·»åŠ é»æ“Šå¤–éƒ¨ç›£è½å™¨
  document.addEventListener('click', handleClickOutside)
  
  // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œè§¸ç™¼è¼‰å…¥
  if (!isLoading.value && !summary.value) {
    recalculateStats()
  }
})

onUnmounted(() => {
  // ç§»é™¤é»æ“Šå¤–éƒ¨ç›£è½å™¨
  document.removeEventListener('click', handleClickOutside)
})
</script>

<style scoped>
.stats-page {
  @apply min-h-screen bg-gray-50 pb-8;
  @apply dark:bg-gray-900;
}

/* é é¢æ¨™é¡Œ */
.page-header {
  @apply bg-white shadow-sm border-b border-gray-200 px-4 py-6 mb-8;
  @apply dark:bg-gray-800 dark:border-gray-700;
}

.header-content {
  @apply max-w-7xl mx-auto flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4;
}

.page-title {
  @apply text-2xl font-bold text-gray-900;
  @apply dark:text-gray-100;
}

.page-subtitle {
  @apply text-sm text-gray-600 mt-1;
  @apply dark:text-gray-400;
}

.header-actions {
  @apply flex items-center gap-4;
}

.time-range-selector .range-select {
  @apply px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm;
  @apply focus:ring-2 focus:ring-blue-500 focus:border-blue-500;
  @apply dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200;
}

.action-buttons {
  @apply flex items-center gap-2;
}

.refresh-btn,
.export-btn {
  @apply flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg;
  @apply hover:bg-blue-600 transition-colors text-sm font-medium;
  @apply disabled:opacity-50 disabled:cursor-not-allowed;
}

.export-dropdown {
  @apply relative;
}

.export-menu {
  @apply absolute right-0 top-full mt-2 w-40 bg-white rounded-lg shadow-lg border border-gray-200;
  @apply dark:bg-gray-700 dark:border-gray-600;
  @apply z-50;
}

.export-option {
  @apply w-full px-4 py-2 text-left text-sm hover:bg-gray-50;
  @apply dark:hover:bg-gray-600 dark:text-gray-200;
  @apply first:rounded-t-lg last:rounded-b-lg;
}

.dropdown-arrow {
  @apply text-xs transition-transform;
}

/* è¼‰å…¥å’ŒéŒ¯èª¤ç‹€æ…‹ */
.loading-container,
.error-container {
  @apply flex flex-col items-center justify-center py-16 px-4;
}

.loading-spinner {
  @apply w-8 h-8 border-4 border-blue-200 border-t-blue-500 rounded-full mb-4;
  animation: spin 1s linear infinite;
}

.loading-text {
  @apply text-gray-600 dark:text-gray-400;
}

.error-content {
  @apply text-center max-w-md;
}

.error-icon {
  @apply text-4xl mb-4;
}

.error-title {
  @apply text-xl font-semibold text-gray-900 mb-2;
  @apply dark:text-gray-100;
}

.error-message {
  @apply text-gray-600 mb-6;
  @apply dark:text-gray-400;
}

.retry-button {
  @apply px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors;
}

/* ä¸»è¦å…§å®¹ */
.stats-content {
  @apply max-w-7xl mx-auto px-4 space-y-8;
}

.section-title {
  @apply text-xl font-semibold text-gray-900 mb-6;
  @apply dark:text-gray-100;
}

/* çµ±è¨ˆå¡ç‰‡ç¶²æ ¼ */
.stats-cards-grid {
  @apply grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-4;
}

/* åœ–è¡¨å€åŸŸ */
.charts-container {
  @apply bg-white rounded-xl shadow-sm border border-gray-200 p-6;
  @apply dark:bg-gray-800 dark:border-gray-700;
}

/* è©³ç´°è³‡æ–™å€åŸŸ */
.details-content {
  @apply grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3;
}

.detail-card {
  @apply bg-white rounded-xl shadow-sm border border-gray-200 p-6;
  @apply dark:bg-gray-800 dark:border-gray-700;
}

.detail-card-title {
  @apply text-lg font-semibold text-gray-900 mb-4;
  @apply dark:text-gray-100;
}

.detail-card-content {
  @apply space-y-3;
}

.detail-row {
  @apply flex justify-between items-center py-2 border-b border-gray-100;
  @apply dark:border-gray-700 last:border-b-0;
}

.detail-label {
  @apply text-sm text-gray-600;
  @apply dark:text-gray-400;
}

.detail-value {
  @apply text-sm font-medium text-gray-900;
  @apply dark:text-gray-100;
}

.no-data-message {
  @apply text-center text-gray-500 py-4;
  @apply dark:text-gray-400;
}

/* å‹•ç•« */
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 640px) {
  .page-header {
    @apply px-4 py-4;
  }
  
  .header-actions {
    @apply flex-col gap-3;
  }
  
  .action-buttons {
    @apply w-full justify-between;
  }
  
  .stats-cards-grid {
    @apply grid-cols-1;
  }
  
  .details-content {
    @apply grid-cols-1;
  }
  
  .btn-text {
    @apply hidden;
  }
}
</style>